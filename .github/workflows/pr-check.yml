---
name: PR Check
on:
  pull_request:
    types: ['opened', 'reopened', 'synchronize']
  merge_group:
  workflow_dispatch:

jobs:
  check:
    permissions: {}
    runs-on: ubuntu-latest
    steps:
      - name: checking for fork
        shell: pwsh
        run: |
          $isFork = "${{ github.event.pull_request.head.repo.fork }}"
          if($isFork -eq "true") {
            echo "### WARNING: This workflow is disabled for forked repositories. Please follow the [release branch process](https://azure.github.io/Azure-Verified-Modules/contributing/terraform/terraform-contribution-flow/#5-create-a-pull-request-to-the-upstream-repository) if end to end tests are required." >> $env:GITHUB_STEP_SUMMARY
          }

  # Use local reusable workflow to run example tests (skips Azure subscription checks)
  run-managed-workflow:
    if: github.event.pull_request.head.repo.fork == false
    uses: Azure/avm-terraform-governance/.github/workflows/managed-pr-check.yml@main
    name: run managed workflow
    # Explicitly pass required secrets to ensure availability in the reusable workflow
    secrets:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      TEST_SUBSCRIPTION_IDS: ${{ secrets.TEST_SUBSCRIPTION_IDS }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      ARM_TENANT_ID_OVERRIDE: ${{ secrets.ARM_TENANT_ID_OVERRIDE }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
      ARM_SUBSCRIPTION_ID_OVERRIDE: ${{ secrets.ARM_SUBSCRIPTION_ID_OVERRIDE }}
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_ID_OVERRIDE: ${{ secrets.ARM_CLIENT_ID_OVERRIDE }}
    permissions:
      id-token: write
      contents: read
