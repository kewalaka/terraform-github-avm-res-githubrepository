---
name: PR Examples

on:
  pull_request:
    types: ['opened', 'reopened', 'synchronize']
  merge_group:
  workflow_dispatch:

jobs:
  check:
    permissions: {}
    runs-on: ubuntu-latest
    steps:
      - name: checking for fork
        shell: pwsh
        run: |
          $isFork = "${{ github.event.pull_request.head.repo.fork }}"
          if($isFork -eq "true") {
            echo "### WARNING: This workflow is disabled for forked repositories. Please follow the [release branch process](https://azure.github.io/Azure-Verified-Modules/contributing/terraform/terraform-contribution-flow/#5-create-a-pull-request-to-the-upstream-repository) if end to end tests are required." >> $env:GITHUB_STEP_SUMMARY
          }

  collect-examples:
    if: github.event.pull_request.head.repo.fork == false
    runs-on: ubuntu-latest
    needs: check
    outputs:
      examples: ${{ steps.collect.outputs.examples }}
    permissions:
      contents: read
    environment: test
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: collect examples
        id: collect
        working-directory: examples
        shell: pwsh
        run: |
          $examples = Get-ChildItem -Directory
          $processedExamples = @()

          for ($i = 0; $i -lt $examples.Count; $i++) {
            if (Test-Path "$(($examples[$i].FullName))/.e2eignore") {
              Write-Host "Skipping example $(($examples[$i].Name)) because it contains a .e2eignore file."
              continue
            }
            $processedExamples += $examples[$i].Name
          }

          $matrixPayload = @{ example = $processedExamples }
          $json = ConvertTo-Json $matrixPayload -Compress

          Write-Host "Matrix payload: $json"
          Write-Output "examples=$json" >> $env:GITHUB_OUTPUT

  setup:
    if: github.event.pull_request.head.repo.fork == false
    runs-on: ubuntu-latest
    needs: collect-examples
    permissions:
      contents: read
    environment: test
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Run examples/setup.sh
        if: ${{ hashFiles('examples/setup.sh') != '' }}
        shell: bash
        run: |
          set -e
          chmod +x examples/setup.sh
          examples/setup.sh

  testexamples:
    if: github.event.pull_request.head.repo.fork == false
    runs-on: ubuntu-latest
    needs: [collect-examples, setup]
    permissions:
      contents: read
    environment: test
    env:
      FORCE_COLOR: 1
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      TF_IN_AUTOMATION: 1
      TF_VAR_enable_telemetry: "false"
    strategy:
      matrix: ${{ fromJson(needs.collect-examples.outputs.examples) }}
      fail-fast: false
    steps:
      - name: Set up Docker
        uses: docker/setup-docker-action@b60f85385d03ac8acfca6d9996982511d8620a19 # v4.3.0
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Normalize TF_VAR secrets
        shell: bash
        run: |
          set -euo pipefail

          python3 <<'PY'
          import os

          env_path = os.environ["GITHUB_ENV"]
          count = 0
          with open(env_path, "a", encoding="utf-8") as handle:
              for key, value in os.environ.items():
                  if not key.startswith("TF_VAR_"):
                      continue

                  lower_key = "TF_VAR_" + key[7:].lower()
                  if lower_key == key or lower_key in os.environ:
                      continue

                  handle.write(f"{lower_key}<<'EOF'\n{value}\nEOF\n")
                  count += 1

          if count:
              print(f"Normalized {count} TF_VAR secrets for Terraform consumption.")
          else:
              print("No TF_VAR secrets required normalization.")
          PY
      - name: Test example
        shell: bash
        env:
          AVM_EXAMPLE: ${{ matrix.example }}
          AVM_RUNNING_IN_GITHUB_ACTIONS: true
        run: |
          set -e
          sudo chmod 666 /var/run/docker.sock

          ./avm test-examples

  teardown:
    if: github.event.pull_request.head.repo.fork == false
    runs-on: ubuntu-latest
    needs: testexamples
    permissions:
      contents: read
    environment: test
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Run examples/teardown.sh
        if: ${{ hashFiles('examples/teardown.sh') != '' }}
        shell: bash
        run: |
          set -e
          chmod +x examples/teardown.sh
          examples/teardown.sh
