---
name: PR Examples

on:
  pull_request:
    types: ['opened', 'reopened', 'synchronize']
  merge_group:
  workflow_dispatch:

jobs:
  check:
    permissions: {}
    runs-on: ubuntu-latest
    steps:
      - name: checking for fork
        shell: pwsh
        run: |
          $isFork = "${{ github.event.pull_request.head.repo.fork }}"
          if($isFork -eq "true") {
            echo "### WARNING: This workflow is disabled for forked repositories. Please follow the [release branch process](https://azure.github.io/Azure-Verified-Modules/contributing/terraform/terraform-contribution-flow/#5-create-a-pull-request-to-the-upstream-repository) if end to end tests are required." >> $env:GITHUB_STEP_SUMMARY
          }

  precommit:
    if: github.event.pull_request.head.repo.fork == false
    runs-on: ubuntu-latest
    needs: check
    permissions:
      contents: read
    environment: test
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Set up Docker
        uses: docker/setup-docker-action@b60f85385d03ac8acfca6d9996982511d8620a19 # v4.3.0
      - name: Skip AVM pre-commit stage
        if: vars.SKIP_PR_EXAMPLES_PRECOMMIT == 'true'
        shell: bash
        run: |
          echo "SKIP_PR_EXAMPLES_PRECOMMIT is true. Skipping ./avm pre-commit."
      - name: Run AVM pre-commit
        if: vars.SKIP_PR_EXAMPLES_PRECOMMIT != 'true'
        shell: bash
        env:
          PORCH_NO_TUI: 1
        run: |
          set -e
          ./avm pre-commit

  collect-examples:
    if: github.event.pull_request.head.repo.fork == false && (needs.precommit.result == 'success' || needs.precommit.result == 'skipped')
    runs-on: ubuntu-latest
    needs:
      - check
      - precommit
    outputs:
      examples: ${{ steps.collect.outputs.examples }}
    permissions:
      contents: read
    environment: test
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: collect examples
        id: collect
        working-directory: examples
        shell: pwsh
        run: |
          $examples = Get-ChildItem -Directory
          $processedExamples = @()

          for ($i = 0; $i -lt $examples.Count; $i++) {
            if (Test-Path "$(($examples[$i].FullName))/.e2eignore") {
              Write-Host "Skipping example $(($examples[$i].Name)) because it contains a .e2eignore file."
              continue
            }
            $processedExamples += $examples[$i].Name
          }

          $matrixPayload = @{ example = $processedExamples }
          $json = ConvertTo-Json $matrixPayload -Compress

          Write-Host "Matrix payload: $json"
          Write-Output "examples=$json" >> $env:GITHUB_OUTPUT

  setup:
    if: github.event.pull_request.head.repo.fork == false
    runs-on: ubuntu-latest
    needs: collect-examples
    permissions:
      contents: read
    environment: test
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Run examples/setup.sh
        if: ${{ hashFiles('examples/setup.sh') != '' }}
        shell: bash
        run: |
          set -e
          chmod +x examples/setup.sh
          examples/setup.sh

  testexamples:
    if: github.event.pull_request.head.repo.fork == false
    runs-on: ubuntu-latest
    needs: [collect-examples, setup]
    permissions:
      contents: read
    environment: test
    env:
      FORCE_COLOR: 1
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      TF_IN_AUTOMATION: 1
      TF_VAR_enable_telemetry: "false"
      TF_VAR_github_app_id: ${{ secrets.TF_VAR_GITHUB_APP_ID }}
      TF_VAR_github_app_installation_id: ${{ secrets.TF_VAR_GITHUB_APP_INSTALLATION_ID }}
      TF_VAR_github_app_pem_file: ${{ secrets.TF_VAR_GITHUB_APP_PEM_FILE }}
      TF_VAR_github_organization_name: ${{ secrets.TF_VAR_GITHUB_ORGANIZATION_NAME }}
    strategy:
      matrix: ${{ fromJson(needs.collect-examples.outputs.examples) }}
      fail-fast: false
    steps:
      - name: Set up Docker
        uses: docker/setup-docker-action@b60f85385d03ac8acfca6d9996982511d8620a19 # v4.3.0
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Test example
        shell: bash
        env:
          AVM_EXAMPLE: ${{ matrix.example }}
          AVM_RUNNING_IN_GITHUB_ACTIONS: true
        run: |
          set -e
          sudo chmod 666 /var/run/docker.sock

          ./avm test-examples

  teardown:
    if: github.event.pull_request.head.repo.fork == false
    runs-on: ubuntu-latest
    needs: testexamples
    permissions:
      contents: read
    environment: test
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Run examples/teardown.sh
        if: ${{ hashFiles('examples/teardown.sh') != '' }}
        shell: bash
        run: |
          set -e
          chmod +x examples/teardown.sh
          examples/teardown.sh
